# fffrp - Fast Forward FRP (Intranet Penetration Tool)

这是一个基于现有成熟库构建的内网穿透项目，旨在避免重复造轮子，专注于核心业务逻辑。

## 1. 产物 (Artifacts)
1.  **客户端 (Client)**
    *   技术栈: Wails + Go + TS + Vue + Element Plus
    *   运行环境: 局域网 (Intranet) - 现场技术支持人员使用
    *   职责: 暴露内网服务，管理本地配置，自动断线重连。
2.  **服务端 (Server)**
    *   技术栈: Go + Gin + TS + Yamux + Vue + Element Plus
    *   运行环境: 公网 (Public Internet) - 公司研发人员使用
    *   职责: 接收客户端连接，监听公网端口，转发流量，提供 Web 管理界面。

## 2. 核心说明 (Core Concepts)
1.  **拓扑结构**: 单服务端 (Server) 对 多客户端 (Client)。
2.  **术语定义**:
    *   **Session**: 指物理 TCP 连接之上的多路复用会话 (Yamux Session)。一个客户端与服务端之间仅建立**一个** Session。
    *   **Stream**: 指在 Session 内部复用的逻辑虚拟链路 (Yamux Stream)。一个 Session 上可以并发 Open **多个** Stream。
3.  **版本校验**: 客户端和服务端代码中写入固定版本号 (如 `1.0.0`)。连接建立时进行校验，若不一致，客户端提示“版本不一致，请升级客户端”并拒绝服务。
4.  **配置同步**: 客户端和服务端均可管理“目标服务列表”。任何一方的增删改操作，都应通过 **Yamux Control Stream (RPC)** 实时同步给对方，保持状态一致。

## 3. 使用者说明 (User Guide)

### 3.1 现场技术支持 (客户端 Client)
*   **配置**:
    *   `config.yaml`: 缓存用户填写的个人信息，避免重复输入。
    *   **连接地址**: 服务端 Yamux 地址目前写死 (如 `127.0.0.1:9001`)，后续可配置。
*   **操作流程**:
    1.  打开客户端，首页显示 4 个输入框：**姓名、电话、项目名称、备注** (支持从缓存读取)。
    2.  填写必填项 (姓名、电话、项目名称) 后，点击“连接”按钮。
    3.  客户端发起 TCP 连接，并建立 Yamux **Session**。
    4.  连接成功显示提示，失败显示错误。
    5.  Session 建立后，客户端立即 Open 首个 **Stream** 用于控制/心跳。
    6.  **目标管理**:
        *   连接成功后，界面显示当前已配置的“目标服务列表” (包含：目标 IP:Port、备注)。
        *   用户可以手动**添加/修改/删除**目标服务 (例如添加未知的内网服务器)。
        *   所有变更将自动同步到服务端。
    7.  **断线重连**:
        *   若网络异常导致连接断开，客户端将自动尝试重连 (例如每 5 秒一次)。
        *   重连成功后，自动恢复身份上报和配置同步。

### 3.2 公司研发 (服务端 Server Web)
*   **配置**:
    *   `config.yaml` (服务端配置):
        *   `web_addr`: Web 管理界面地址 (如 `:9000`)。
        *   `yamux_addr`: 客户端连接监听地址 (如 `:9001`)。
        *   `port_start`: 映射端口起始号 (如 `10000`)。
*   **Web 界面**:
    *   无需账号密码，支持 WebSocket 实时更新数据。
    *   **首页 (列表层)**: 显示所有已连接的客户端信息 (姓名、电话、项目名称、备注)。
    *   **详情页 (详情层)**: 点击某个客户端进入，管理该客户端的端口映射。
*   **操作流程**:
    1.  研发在详情页查看该客户端的“目标服务列表”。
    2.  研发可以**添加/修改/删除**目标服务：
        *   填写目标内网 `IP:Port` (如 `192.168.1.100:8080`)。
        *   填写**备注** (如 `这个是 master 节点`)。
    3.  服务端分配一个公网端口 (如 `10000`) 并开始 `Listen`。
    4.  **同步**: 任何变更都会通过控制流 (RPC) 实时推送到客户端 UI 显示。
    5.  **懒加载机制**:
        *   此时**不**与客户端进行任何网络交互。
        *   直到**外部用户** (如通过 SSH/浏览器) 连接到服务端的 `10000` 端口。
        *   服务端在对应的 Yamux **Session** 上 Open 新 **Stream**。
        *   发送握手包 (包含目标 IP:Port)。
        *   客户端连接内网目标成功后，服务端才开始 `io.Copy` 转发流量；否则关闭连接。

## 4. 通信流程 (Protocol)

连接建立后，一个 Yamux **Session** 将被复用于两种类型的 **Stream**：

### 4.1 控制流 (Control Stream)
*   **定义**: 客户端和服务端连接建立 Session 后，由客户端主动 Open 的**第一个 Stream**。
*   **用途**: 专用于 RPC (Remote Procedure Call) 控制指令交互。
*   **实现**: 使用 Go 标准库 `net/rpc`。
    *   *注意*: 为了实现双向 RPC (Server Push)，底层可能涉及服务端反向 Open Stream 或双向 RPC 封装。
*   **功能**:
    *   **身份上报**: 客户端连接后立即上报用户信息 (姓名、电话等) 和版本号。
    *   **配置同步 (双向)**:
        *   **C -> S**: 客户端新增/修改/删除目标服务 -> RPC 调用服务端接口 -> 服务端更新内存并广播到 Web。
        *   **S -> C**: 服务端 (Web) 新增/修改/删除目标服务 -> RPC 调用客户端接口 -> 客户端更新本地 UI。
    *   **心跳 (KeepAlive)**: 定时发送心跳包，维持 Session 活跃。

### 4.2 数据流 (Data Stream)
*   **定义**: 除控制流以外的其他 Stream，由服务端在接收到外部用户请求时主动 Open。
*   **用途**: 承载实际的业务流量穿透。
*   **流程**:
    1.  **监听**: 服务端根据 Web 配置，动态监听一个公网端口 (Public Port)。
    2.  **触发**: 当外部用户连接该公网端口时，服务端在对应的 Yamux **Session** 上 Open 一个新的 **Stream**。
    3.  **握手 (Handshake)**:
        *   服务端在 **Stream** 建立后的**第一条消息**，发送目标内网地址和端口 (Target IP:Port)。
        *   协议格式需预定义 (例如: `Length(2byte) | JSON Body` 或简单的定长结构)。
    4.  **连接**: 客户端收到握手消息后，解析目标地址，连接局域网内的目标服务。
    5.  **转发**: 连接建立成功后，客户端在 `Stream` 和 `Local Conn` 之间进行双向 `io.Copy`。

## 5. 开发计划
1.  **基础架构**: 搭建 Wails Client 和 Gin Server 框架。
2.  **核心通信**: 实现 Yamux **Session** 连接、版本校验、`net/rpc` 控制 **Stream**。
3.  **Web 管理**: 实现服务端 Web 列表页、详情页及 WebSocket 推送。
4.  **数据穿透**: 实现动态端口监听、数据 **Stream** 握手协议、懒加载转发逻辑。
5.  **配置与同步**: 实现客户端和服务端双向配置同步 (RPC 接口定义)。
6.  **稳定性**: 实现客户端断线重连机制。
